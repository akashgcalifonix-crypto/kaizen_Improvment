<script>
// !!! UPDATE SCRIPT URL HERE !!!
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzcXvGx_kCBEawCt1S86xsxa64cOMBSQfqwTYqKHVv8iqy9N4X2rpn78z7oU4eo8fzF-w/exec"; 

let imgData = { asWas: null, asIs: null, asWasName: "", asIsName: "" };
let allRecords = [];

function previewFile(inputId) {
  const file = document.getElementById(inputId).files[0];
  const reader = new FileReader();
  reader.onloadend = function() {
    if(inputId === 'aswas_img') { imgData.asWas = reader.result; imgData.asWasName = file.name; } 
    else { imgData.asIs = reader.result; imgData.asIsName = file.name; }
  }
  if (file) reader.readAsDataURL(file);
}

// --- HELPER: Convert Drive Link to Direct Image Link ---
function getDirectLink(url) {
    if (!url) return "";
    // Agar data:image (base64) hai to waisa hi rehne dein
    if (url.startsWith("data:") || url.startsWith("blob:")) return url;
    
    // Google Drive URL se ID nikal kar Direct Thumbnail Link banana
    // Ye format sabse reliable hai images dikhane ke liye
    const idMatch = url.match(/[-\w]{25,}/);
    if (idMatch && (url.includes("drive.google.com") || url.includes("docs.google.com"))) {
        return "https://drive.google.com/thumbnail?id=" + idMatch[0] + "&sz=w2000"; // sz=w2000 high quality ke liye
    }
    return url;
}

// --- CRUD OPERATIONS ---

// 1. READ (Load Data)
async function loadData() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Loading...</td></tr>";
    
    try {
        const response = await fetch(SCRIPT_URL);
        const json = await response.json();
        
        if(json.status === "success") {
            allRecords = json.data;
            renderTable(allRecords);
        } else {
            alert("Error loading data: " + json.message);
        }
    } catch(e) {
        console.error(e);
        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; color:red;'>Network Error. Check Console.</td></tr>";
    }
}

function renderTable(data) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = "";
    if(data.length === 0) { tbody.innerHTML = "<tr><td colspan='5'>No records found.</td></tr>"; return; }

    data.forEach((row, index) => {
        const date = new Date(row.date).toLocaleDateString();
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${date}</td>
            <td><strong>${row.topic}</strong></td>
            <td>${row.proposer}</td>
            <td>${row.status}</td>
            <td>
                <button class="btn btn-preview" style="font-size:11px;" onclick="loadRecordIntoForm(${index})">Edit</button>
                <button class="btn btn-danger" style="font-size:11px;" onclick="deleteRecord(${row.rowIndex})">Delete</button>
                <button class="btn btn-sec" style="font-size:11px;" onclick="generatePreviewFromData(${index})">PDF</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// 2. FILL FORM (For Edit)
function loadRecordIntoForm(arrayIndex) {
    const r = allRecords[arrayIndex];
    document.getElementById('editRowIndex').value = r.rowIndex;
    
    document.getElementById('topic').value = r.topic;
    document.getElementById('plant').value = r.plant;
    document.getElementById('area').value = r.area;
    document.getElementById('effect').value = r.effect;
    document.getElementById('proposer').value = r.proposer;
    
    document.getElementById('aswas_points').value = r.asWasPoints;
    document.getElementById('aswas_cap').value = r.asWasImg ? r.asWasImg.split('_').pop() : ""; 
    document.getElementById('prev_aswas_img').innerText = r.asWasImg ? "Previous Image Exists" : "No Image";
    
    document.getElementById('asis_points').value = r.asIsPoints;
    document.getElementById('asis_cap').value = r.asIsImg ? r.asIsImg.split('_').pop() : "";
    document.getElementById('asis_video').value = r.asIsVideo;
    document.getElementById('prev_asis_img').innerText = r.asIsImg ? "Previous Image Exists" : "No Image";

    document.getElementById('benefits').value = r.benefits;
    document.getElementById('status').value = r.status;
    document.getElementById('remarks').value = r.remarks;
    
    if(r.eta) {
        const d = new Date(r.eta);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        document.getElementById('eta').value = `${yyyy}-${mm}-${dd}`;
    }

    document.getElementById('saveBtn').innerText = "Update Record";
    window.scrollTo(0,0);
    
    imgData = { asWas: null, asIs: null, asWasName: "", asIsName: "" }; 
}

// 3. CREATE / UPDATE
async function saveData() {
    const btn = document.getElementById('saveBtn');
    const rowIndex = document.getElementById('editRowIndex').value;
    const action = rowIndex ? "update" : "create";
    
    btn.innerText = "Processing..."; btn.disabled = true;

    const payload = {
        action: action,
        data: {
            rowIndex: rowIndex,
            topic: document.getElementById('topic').value,
            plant: document.getElementById('plant').value,
            area: document.getElementById('area').value,
            effect: document.getElementById('effect').value,
            proposer: document.getElementById('proposer').value,
            
            asWasPoints: document.getElementById('aswas_points').value,
            asWasImgData: imgData.asWas, asWasImgName: imgData.asWasName,
            
            asIsPoints: document.getElementById('asis_points').value,
            asIsImgData: imgData.asIs, asIsImgName: imgData.asIsName, asIsVideo: document.getElementById('asis_video').value,
            
            benefits: document.getElementById('benefits').value,
            status: document.getElementById('status').value,
            statusRemarks: document.getElementById('remarks').value,
            eta: document.getElementById('eta').value
        }
    };

    try {
        await fetch(SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        
        alert("Success! Request Sent.");
        clearForm();
        setTimeout(loadData, 2000); 
    } catch(e) {
        alert("Error sending data");
        console.error(e);
    }
    btn.innerText = "Save / Update Record"; btn.disabled = false;
}

// 4. DELETE
async function deleteRecord(rowIndex) {
    if(!confirm("Are you sure you want to delete this record?")) return;
    
    try {
        await fetch(SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify({ action: "delete", rowIndex: rowIndex })
        });
        alert("Deleted Request Sent.");
        setTimeout(loadData, 2000);
    } catch(e) { alert("Error deleting."); }
}

function clearForm() {
    document.querySelectorAll("input, textarea").forEach(el => el.value = "");
    document.getElementById('editRowIndex').value = "";
    document.getElementById('saveBtn').innerText = "Save Record";
    document.getElementById('prev_aswas_img').innerText = "";
    document.getElementById('prev_asis_img').innerText = "";
}

// --- PREVIEW LOGIC ---
function generatePreview() {
    fillPreviewFromForm();
    document.getElementById('previewModal').style.display = 'flex';
}

function generatePreviewFromData(index) {
    loadRecordIntoForm(index);
    fillPreviewFromForm();
    
    const r = allRecords[index];
    
    const setImg = (id, rawUrl) => { 
        const el = document.getElementById(id);
        // Yahan par hum URL ko convert kar rahe hain Direct Link mein
        const directUrl = getDirectLink(rawUrl);
        
        if(directUrl){ 
            el.setAttribute('crossOrigin', 'anonymous'); 
            el.src = directUrl; 
            el.style.display='block'; 
        }
        else { 
            el.style.display='none'; 
        } 
    };
    
    // Naya upload nahi hai to saved image use karein
    if(!imgData.asWas && r.asWasImg) setImg('p_aswas_img', r.asWasImg);
    if(!imgData.asIs && r.asIsImg) setImg('p_asis_img', r.asIsImg);

    document.getElementById('previewModal').style.display = 'flex';
}

function fillPreviewFromForm() {
    document.getElementById('p_topic').innerText = document.getElementById('topic').value;
    document.getElementById('p_plant').innerText = document.getElementById('plant').value;
    document.getElementById('p_area').innerText = document.getElementById('area').value;
    document.getElementById('p_effect').innerText = document.getElementById('effect').value;
    document.getElementById('p_proposer').innerText = document.getElementById('proposer').value;
    document.getElementById('p_benefits').innerText = document.getElementById('benefits').value;
    document.getElementById('p_status').innerText = document.getElementById('status').value;
    document.getElementById('p_remarks').innerText = document.getElementById('remarks').value;
    document.getElementById('p_eta').innerText = document.getElementById('eta').value;
    
    const makeList = (txt) => txt.split('\n').map(i => i.trim() ? `<li>${i}</li>` : '').join('');
    document.getElementById('p_aswas_list').innerHTML = makeList(document.getElementById('aswas_points').value);
    document.getElementById('p_asis_list').innerHTML = makeList(document.getElementById('asis_points').value);

    // Direct Upload ke liye (Jab user form bhar raha ho)
    const setImg = (id, src) => { const el = document.getElementById(id); if(src){ el.src=src; el.style.display='block'; } else { el.style.display='none'; } };
    if(imgData.asWas) setImg('p_aswas_img', imgData.asWas);
    if(imgData.asIs) setImg('p_asis_img', imgData.asIs);
}

function closeModal() { document.getElementById('previewModal').style.display = 'none'; }

function downloadPDF() {
    const element = document.getElementById('slide-to-print');
    const topic = document.getElementById('topic').value || "Kaizen";
    
    // Best Options for rendering Google Images
    const opt = {
      margin: 0,
      filename: `Kaizen_${topic}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, allowTaint: true, scrollY: 0 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
    };

    html2pdf().set(opt).from(element).save();
}

loadData();
</script>
