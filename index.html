<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Improvements Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Libraries for PDF and PPT -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
  
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f4f9; padding: 20px; }
    .control-panel { max-width: 1000px; margin: 0 auto 30px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h2 { color: #1f4e79; border-bottom: 2px solid #eee; padding-bottom: 10px; display:flex; justify-content:space-between; }
    
    .form-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
    .form-group { flex: 1; min-width: 200px; }
    label { display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px; }
    input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    
    .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; margin-right: 5px; }
    .btn-save { background: #1f4e79; }
    .btn-preview { background: #ed7d31; }
    .btn-ppt { background: #d24726; }
    .btn-danger { background: #dc3545; }
    .btn-sec { background: #6c757d; }
    
    /* Monthly Report Box */
    .report-box { background: #e8f4f8; border: 1px solid #bce0fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .report-box h3 { margin-top: 0; color: #1f4e79; font-size: 16px; }

    /* TABLE */
    .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
    .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    .data-table th { background-color: #1f4e79; color: white; }
    .data-table tr:hover { background-color: #f1f1f1; }

    /* MODAL */
    .preview-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; overflow-y: auto; padding-top: 20px; }
    .preview-content { background: #555; padding: 20px; border-radius: 5px; width: fit-content; }
    
    /* SLIDE CSS */
    .slide { width: 297mm; height: 210mm; background: white; padding: 10mm; position: relative; display: flex; flex-direction: column; font-family: 'Calibri', sans-serif; box-sizing: border-box;}
    .slide-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
    .header-title { font-size: 36pt; font-weight: bold; color: #1f4e79; font-family: 'Georgia', serif; margin: 0; }
    .logo-area { text-align: right; }
    .califonix-logo { height: 40px; margin-bottom: 5px; }
    .top-table { border-collapse: collapse; width: 400px; font-size: 11pt; text-align: center; float: right; }
    .top-table th { background: #f2f2f2; border: 1px solid #bfbfbf; padding: 4px; font-weight: bold; color: #000; }
    .top-table td { border: 1px solid #bfbfbf; padding: 4px; }
    .text-green { color: #00b050; font-weight: bold; }
    
    .topic-row { clear: both; margin-bottom: 10px; font-size: 18pt; font-weight: bold; display: flex; align-items: center; }
    .square { width: 12px; height: 12px; border: 2px solid #555; margin-right: 8px; display: inline-block; }
    .topic-label { color: #c00000; margin-right: 5px; }
    .topic-val { color: #0070c0; }
    
    .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; flex-grow: 1; border-top: 2px solid #eee; padding-top: 10px; }
    .col-header { background: linear-gradient(to right, #367fa9, #5c9ccc); color: white; font-weight: bold; padding: 5px 15px; border-radius: 0 10px 10px 0; font-size: 14pt; width: fit-content; margin-bottom: 15px; }
    .bullet-points { padding-left: 20px; margin: 0 0 15px 0; font-size: 12pt; line-height: 1.4; }
    
    /* UPDATED IMAGE BOX TO FIT CAPTION */
    .img-box { border: 1px dashed #ccc; padding: 5px; text-align: center; height: auto; min-height: 250px; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; background: #fdfdfd; overflow: hidden; padding-bottom: 10px; }
    .main-img { max-width: 100%; max-height: 220px; object-fit: contain; margin-bottom: 5px; }
    .img-caption { color: #2e75b6; font-size: 12pt; margin-top: 5px; font-weight: bold; background: #eef7ff; width: 100%; padding: 2px 0; }
    
    .footer { margin-top: auto; display: flex; border: 1px solid #ccc; font-size: 11pt; }
    .benefits-label { background-color: #2e75b6; color: white; font-weight: bold; font-size: 14pt; padding: 10px; width: 120px; display: flex; align-items: center; justify-content: center; }
    .benefits-content { flex: 1; padding: 10px; display: flex; align-items: center; }
    .status-table { border-collapse: collapse; width: 450px; text-align: center; font-size: 10pt; }
    .status-table th { background: #ed7d31; color: white; padding: 5px; border: 1px solid white; }
    .status-table td { background: #fbe5d6; padding: 5px; border: 1px solid white; }
    .status-green { background: #92d050 !important; color: black; font-weight: bold; }

    .loader { display: none; margin-left: 10px; font-size: 14px; color: #d24726; font-weight: bold; background: white; padding: 5px; border-radius: 4px;}
  </style>
</head>
<body>

<div class="control-panel">
  <div style="text-align: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
      <img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height: 80px;" alt="Company Logo" crossorigin="anonymous">
  </div>

  <h2>
    <span>Improvements Tracker</span>
    <button class="btn btn-sec" onclick="loadData()">üîÑ Refresh Data</button>
  </h2>
  
  <input type="hidden" id="editRowIndex"> 

  <div class="form-row">
      <div class="form-group"><label>Topic</label><input type="text" id="topic"></div>
      <div class="form-group"><label>Plant</label><input type="text" id="plant" value="Califonix"></div>
      <div class="form-group"><label>Area</label><input type="text" id="area"></div>
      <div class="form-group"><label>Effect</label><input type="text" id="effect" value="Quality Improvement"></div>
      <div class="form-group"><label>Proposer</label><input type="text" id="proposer"></div>
  </div>

  <div class="form-row">
      <!-- As Was -->
      <div class="form-group" style="background:#f9f9f9; padding:10px;">
          <h3 style="margin-top:0; color:#c00000;">As-Was (Before)</h3>
          <label>Details</label><textarea id="aswas_points" rows="4"></textarea>
          <label>Upload Image</label><input type="file" id="aswas_img" onchange="previewFile('aswas_img')">
          <label>Caption</label><input type="text" id="aswas_cap" placeholder="Write caption for As-Was image">
          <div id="prev_aswas_img" style="font-size:11px; color:blue;"></div>
      </div>

      <!-- As Is -->
      <div class="form-group" style="background:#f0f8ff; padding:10px;">
          <h3 style="margin-top:0; color:#0070c0;">As-Is (After)</h3>
          <label>Details</label><textarea id="asis_points" rows="4"></textarea>
          <label>Upload Image</label><input type="file" id="asis_img" onchange="previewFile('asis_img')">
          <label>Caption</label><input type="text" id="asis_cap" placeholder="Write caption for As-Is image">
          <label>Video Link</label><input type="text" id="asis_video">
          <div id="prev_asis_img" style="font-size:11px; color:blue;"></div>
      </div>
  </div>

  <div class="form-row">
      <div class="form-group"><label>Benefits</label><input type="text" id="benefits"></div>
      <div class="form-group"><label>Status</label>
        <select id="status"><option>Implemented</option><option>In Progress</option></select>
      </div>
      <div class="form-group"><label>Remarks</label><input type="text" id="remarks" value="-"></div>
      <div class="form-group"><label>ETA</label><input type="date" id="eta"></div>
  </div>

  <div style="text-align:center; margin-top:20px;">
      <button class="btn btn-save" id="saveBtn" onclick="saveData()">Save / Update Record</button>
      <button class="btn btn-sec" onclick="clearForm()">Clear Form</button>
      <button class="btn btn-preview" id="viewBtn" onclick="generatePreviewFromForm()">Preview PDF / PPT</button>
      <span id="loadingMsg" class="loader">üîÑ Loading Preview...</span>
  </div>
</div>

<!-- MONTHLY REPORT & DATA TABLE -->
<div class="control-panel">
    <!-- Monthly Report Tab -->
    <div class="report-box">
        <h3>üìÖ Download Monthly Report (PPT)</h3>
        <div class="form-row" style="align-items: flex-end;">
            <div class="form-group" style="flex: 0 0 150px;">
                <label>Select Month</label>
                <select id="reportMonth">
                    <option value="0">January</option><option value="1">February</option><option value="2">March</option>
                    <option value="3">April</option><option value="4">May</option><option value="5">June</option>
                    <option value="6">July</option><option value="7">August</option><option value="8">September</option>
                    <option value="9">October</option><option value="10">November</option><option value="11">December</option>
                </select>
            </div>
            <div class="form-group" style="flex: 0 0 100px;">
                <label>Year</label>
                <input type="number" id="reportYear" value="2026">
            </div>
            <div class="form-group">
                <button class="btn btn-ppt" id="btnMonthlyPPT" onclick="downloadMonthlyPPT()">üì• Download All Slides for Selected Month</button>
                <span id="reportLoader" class="loader">‚è≥ Generating Slides...</span>
            </div>
        </div>
    </div>

    <h3>Existing Records</h3>
    <table class="data-table">
        <thead>
            <tr><th>Date</th><th>Topic</th><th>Proposer</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="5" style="text-align:center;">Click "Refresh Data" to load...</td></tr>
        </tbody>
    </table>
</div>

<!-- PREVIEW MODAL -->
<div id="previewModal" class="preview-modal">
    <div class="preview-content">
        <div style="text-align:right; margin-bottom:10px;">
            <button class="btn btn-ppt" id="btnSinglePPT" onclick="downloadPPT()">Download Current Slide PPT</button>
            <button class="btn btn-save" onclick="downloadPDF()">Download Current Slide PDF</button>
            <button class="btn btn-sec" onclick="closeModal()">Close</button>
            <span id="dlLoader" class="loader">‚è≥ Converting...</span>
        </div>
        
        <div id="slide-to-print" class="slide">
            <div class="slide-header">
                <h1 class="header-title">Best Practices</h1>
                <div class="logo-area">
                    <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="califonix-logo" crossorigin="anonymous">
                    <table class="top-table">
                        <tr><th>Plant</th><th>Area</th><th>Effect</th><th>Proposer</th></tr>
                        <tr><td id="p_plant"></td><td id="p_area"></td><td id="p_effect" class="text-green"></td><td id="p_proposer"></td></tr>
                    </table>
                </div>
            </div>
            <div class="topic-row">
                <div class="square"></div><span class="topic-label">Topic- </span><span id="p_topic" class="topic-val"></span>
            </div>
            <div class="main-grid">
                <div>
                    <div class="col-header">As-Was</div>
                    <ul id="p_aswas_list" class="bullet-points"></ul>
                    <div class="img-box">
                        <img id="p_aswas_img" class="main-img" style="display:none;" crossorigin="anonymous">
                        <div id="p_aswas_cap" class="img-caption"></div>
                    </div>
                </div>
                <div>
                    <div class="col-header">As-Is</div>
                    <ul id="p_asis_list" class="bullet-points"></ul>
                    <div class="img-box">
                        <img id="p_asis_img" class="main-img" style="display:none;" crossorigin="anonymous">
                        <div id="p_asis_cap" class="img-caption"></div>
                        <div id="p_asis_vid" style="font-size:10px; color:blue;"></div>
                    </div>
                </div>
            </div>
            <div class="footer">
                <div class="benefits-label">Benefits</div>
                <div class="benefits-content">- <span id="p_benefits"></span></div>
                <table class="status-table">
                    <tr><th>Implementation Status</th><th>Remarks</th><th>ETA</th></tr>
                    <tr><td id="p_status" class="status-green"></td><td id="p_remarks"></td><td id="p_eta"></td></tr>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// !!! UPDATE SCRIPT URL !!!
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzcXvGx_kCBEawCt1S86xsxa64cOMBSQfqwTYqKHVv8iqy9N4X2rpn78z7oU4eo8fzF-w/exec"; 

let imgData = { asWas: null, asIs: null, asWasName: "", asIsName: "" };
let allRecords = [];

// Helper: Get Proxy URL (LH3) for fast visual preview
function getProxyUrl(url) {
    if (!url) return null;
    if (url.startsWith("data:")) return url;
    const idMatch = url.match(/[-\w]{25,}/);
    if (!idMatch) return url;
    return `https://lh3.googleusercontent.com/d/${idMatch[0]}=s2000`;
}

// Helper: Get Base64 for PPT Export
async function getBase64FromUrl(url) {
    const proxyUrl = getProxyUrl(url);
    if(!proxyUrl) return null;
    if(proxyUrl.startsWith("data:")) return proxyUrl;

    return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = "Anonymous"; 
        img.src = proxyUrl;
        
        img.onload = function() {
            const canvas = document.createElement('canvas');
            canvas.width = this.naturalWidth;
            canvas.height = this.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(this, 0, 0);
            try { resolve(canvas.toDataURL('image/jpeg')); } catch (err) { resolve(null); }
        };
        img.onerror = function() { resolve(null); };
    });
}

function previewFile(inputId) {
  const file = document.getElementById(inputId).files[0];
  const reader = new FileReader();
  reader.onloadend = function() {
    if(inputId === 'aswas_img') { imgData.asWas = reader.result; imgData.asWasName = file.name; } 
    else { imgData.asIs = reader.result; imgData.asIsName = file.name; }
  }
  if (file) reader.readAsDataURL(file);
}

// --- CRUD ---
async function loadData() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Loading...</td></tr>";
    try {
        const response = await fetch(SCRIPT_URL);
        const json = await response.json();
        if(json.status === "success") {
            allRecords = json.data;
            renderTable(allRecords);
        } else { alert("Error: " + json.message); }
    } catch(e) { tbody.innerHTML = "<tr><td colspan='5' style='color:red; text-align:center;'>Network Error</td></tr>"; }
}

function renderTable(data) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = "";
    if(data.length === 0) { tbody.innerHTML = "<tr><td colspan='5'>No records found.</td></tr>"; return; }
    data.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${new Date(row.date).toLocaleDateString()}</td>
            <td><strong>${row.topic}</strong></td>
            <td>${row.proposer}</td>
            <td>${row.status}</td>
            <td>
                <button class="btn btn-preview" style="font-size:11px;" onclick="loadRecordIntoForm(${index});">Edit</button>
                <button class="btn btn-danger" style="font-size:11px;" onclick="deleteRecord(${row.rowIndex})">Delete</button>
                <button class="btn btn-sec" style="font-size:11px;" onclick="prepareView(${index})">View</button>
            </td>`;
        tbody.appendChild(tr);
    });
}

// Safe Loading Function
function loadRecordIntoForm(index) {
    try {
        const r = allRecords[index];
        if(!r) return;

        document.getElementById('editRowIndex').value = r.rowIndex;
        
        document.getElementById('topic').value = r.topic || "";
        document.getElementById('plant').value = r.plant || "Califonix";
        document.getElementById('area').value = r.area || "";
        document.getElementById('effect').value = r.effect || "";
        document.getElementById('proposer').value = r.proposer || "";
        document.getElementById('benefits').value = r.benefits || "";
        document.getElementById('status').value = r.status || "Implemented";
        document.getElementById('remarks').value = r.statusRemarks || r.remarks || "-";

        document.getElementById('aswas_points').value = r.asWasPoints || "";
        document.getElementById('asis_points').value = r.asIsPoints || "";
        document.getElementById('asis_video').value = r.asIsVideo || "";
        document.getElementById('aswas_cap').value = r.asWasCaption || ""; 
        document.getElementById('asis_cap').value = r.asIsCaption || ""; 
        
        // Date parsing safety check
        if(r.eta) { 
            try {
                const d = new Date(r.eta);
                if(!isNaN(d)) document.getElementById('eta').value = d.toISOString().split('T')[0];
            } catch(e) { console.log("Date error", e); }
        }

        document.getElementById('prev_aswas_img').innerText = r.asWasImg ? "Image Available" : "No Image";
        document.getElementById('prev_asis_img').innerText = r.asIsImg ? "Image Available" : "No Image";
        
        document.getElementById('saveBtn').innerText = "Update Record";
        imgData = { asWas: null, asIs: null }; 
        window.scrollTo(0,0);
        return true; // Success
    } catch(e) {
        console.error("Load Error:", e);
        return false;
    }
}

// View Shortcut
function prepareView(index) {
    const success = loadRecordIntoForm(index);
    if(success) {
        generatePreviewFromForm();
    } else {
        alert("Error loading record data.");
    }
}

async function saveData() {
    const btn = document.getElementById('saveBtn');
    btn.innerText = "Processing..."; btn.disabled = true;
    
    const payload = {
        action: document.getElementById('editRowIndex').value ? "update" : "create",
        data: {
            rowIndex: document.getElementById('editRowIndex').value,
            topic: document.getElementById('topic').value,
            plant: document.getElementById('plant').value,
            area: document.getElementById('area').value,
            effect: document.getElementById('effect').value,
            proposer: document.getElementById('proposer').value,
            
            asWasPoints: document.getElementById('aswas_points').value,
            asWasImgData: imgData.asWas, 
            asWasImgName: imgData.asWas ? "img_aswas.jpg" : "",
            asWasCaption: document.getElementById('aswas_cap').value,
            
            asIsPoints: document.getElementById('asis_points').value,
            asIsImgData: imgData.asIs, 
            asIsImgName: imgData.asIs ? "img_asis.jpg" : "",
            asIsCaption: document.getElementById('asis_cap').value,
            
            asIsVideo: document.getElementById('asis_video').value,
            benefits: document.getElementById('benefits').value,
            status: document.getElementById('status').value,
            statusRemarks: document.getElementById('remarks').value,
            eta: document.getElementById('eta').value
        }
    };

    try {
        await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        alert("Success! Request Sent."); clearForm(); setTimeout(loadData, 2000);
    } catch(e) { alert("Error sending data"); }
    btn.innerText = "Save / Update Record"; btn.disabled = false;
}

async function deleteRecord(idx) {
    if(!confirm("Delete?")) return;
    try { await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "delete", rowIndex: idx }) }); alert("Deleted."); setTimeout(loadData, 2000); } catch(e){}
}

function clearForm() {
    document.querySelectorAll("input, textarea").forEach(el => el.value = "");
    document.getElementById('saveBtn').innerText = "Save Record";
}

// --- PREVIEW LOGIC (FAIL-SAFE) ---
function generatePreviewFromForm() {
    try {
        const safeVal = (id) => document.getElementById(id) ? document.getElementById(id).value : "";

        // 1. Map Text Fields
        const ids = ['topic','plant','area','effect','proposer','benefits','status','remarks','eta'];
        ids.forEach(id => {
            if(document.getElementById('p_'+id)) document.getElementById('p_'+id).innerText = safeVal(id);
        });

        const makeList = (t) => t ? t.split('\n').map(i=>i.trim()?`<li>${i}</li>`:'').join('') : "";
        document.getElementById('p_aswas_list').innerHTML = makeList(safeVal('aswas_points'));
        document.getElementById('p_asis_list').innerHTML = makeList(safeVal('asis_points'));
        
        document.getElementById('p_aswas_cap').innerText = safeVal('aswas_cap');
        document.getElementById('p_asis_cap').innerText = safeVal('asis_cap');

        // 2. Map Images (Use Proxy URL for visual preview to avoid CORS lag)
        const handleImg = (imgId, localData, savedRecImg) => {
            const el = document.getElementById(imgId);
            if(!el) return;
            if (localData) {
                el.src = localData; 
                el.style.display = 'block';
            } else if (savedRecImg) {
                el.src = getProxyUrl(savedRecImg); 
                el.style.display = 'block';
            } else {
                el.style.display = 'none';
            }
        };

        const idx = document.getElementById('editRowIndex').value;
        let savedRec = allRecords.find(r => r.rowIndex == idx) || {};

        handleImg('p_aswas_img', imgData.asWas, savedRec.asWasImg);
        handleImg('p_asis_img', imgData.asIs, savedRec.asIsImg);

        document.getElementById('previewModal').style.display = 'flex';
    } catch(e) {
        console.error("Preview Error", e);
        alert("Could not generate preview. Check console for details.");
    }
}

function closeModal() { document.getElementById('previewModal').style.display = 'none'; }

function downloadPDF() {
    const el = document.getElementById('slide-to-print');
    const topic = document.getElementById('topic').value || "Kaizen";
    html2pdf().set({ 
        margin:0, 
        filename: `Kaizen_${topic}.pdf`, 
        image:{type:'jpeg',quality:0.98}, 
        html2canvas:{scale:2, useCORS:true, allowTaint:true}, 
        jsPDF:{unit:'mm', format:'a4', orientation:'landscape'} 
    }).from(el).save();
}

// --- PPT GENERATION (SINGLE) ---
async function downloadPPT() {
    const btn = document.getElementById('btnSinglePPT');
    const loader = document.getElementById('dlLoader');
    btn.disabled = true; loader.style.display = "inline-block";

    try {
        let pres = new PptxGenJS();
        pres.layout = 'LAYOUT_WIDE'; 
        let slide = pres.addSlide();

        // 1. HEADER
        slide.addText("Best Practices", { x: 0.5, y: 0.3, fontSize: 32, bold: true, color: '1F4E79', fontFace: 'Georgia' });
        slide.addImage({ path: "https://i.postimg.cc/5y7SN4xc/logo.png", x: 11.5, y: 0.2, w: 1.5, h: 0.6 });

        // 2. TABLES
        slide.addTable([['Plant', 'Area', 'Effect', 'Proposer']], { x: 8, y: 0.9, w: 5, colW: [1.2, 1.2, 1.4, 1.2], fontSize: 11, align: 'center', fill: 'f2f2f2', bold: true, color: '000000', border: {pt:1, color:'bfbfbf'} });
        slide.addTable([[
            document.getElementById('p_plant').innerText,
            document.getElementById('p_area').innerText,
            document.getElementById('p_effect').innerText,
            document.getElementById('p_proposer').innerText
        ]], { x: 8, y: 1.25, w: 5, colW: [1.2, 1.2, 1.4, 1.2], fontSize: 11, align: 'center', color: '000000', border: {pt:1, color:'bfbfbf'} });

        // 3. TOPIC
        slide.addShape(pres.ShapeType.rect, { x: 0.5, y: 1.7, w: 0.15, h: 0.15, line: '555555', fill: 'ffffff' });
        slide.addText([
            { text: "Topic- ", options: { color: 'C00000', bold: true } },
            { text: document.getElementById('p_topic').innerText, options: { color: '0070C0' } }
        ], { x: 0.7, y: 1.6, w: 12, fontSize: 18, bold: true });

        // 4. CONTENT
        slide.addText("As-Was", { x: 0.5, y: 2.2, w: 1.5, h: 0.4, fill: '367FA9', color: 'FFFFFF', bold: true, align: 'center' });
        slide.addText("As-Is", { x: 7.0, y: 2.2, w: 1.5, h: 0.4, fill: '367FA9', color: 'FFFFFF', bold: true, align: 'center' });

        slide.addText(document.getElementById('aswas_points').value, { x: 0.5, y: 2.7, w: 6, h: 1.5, fontSize: 12, valign: 'top', bullet: true });
        slide.addText(document.getElementById('asis_points').value, { x: 7.0, y: 2.7, w: 6, h: 1.5, fontSize: 12, valign: 'top', bullet: true });

        // 5. IMAGES (Convert to Base64 NOW for the download)
        slide.addShape(pres.ShapeType.rect, { x: 0.5, y: 4.2, w: 6, h: 2.5, line: {type:'dash', color:'cccccc'}, fill:'fdfdfd' });
        slide.addShape(pres.ShapeType.rect, { x: 7.0, y: 4.2, w: 6, h: 2.5, line: {type:'dash', color:'cccccc'}, fill:'fdfdfd' });

        const getImgSrc = (id) => { const el = document.getElementById(id); return (el.style.display !== 'none' && el.src) ? el.src : null; };
        const src1 = getImgSrc('p_aswas_img');
        const src2 = getImgSrc('p_asis_img');

        if(src1) {
            const b64 = await getBase64FromUrl(src1);
            if(b64) slide.addImage({ data: b64, x: 2.0, y: 4.3, w: 3, h: 2, sizing: { type: 'contain', w: 3, h: 2 } });
        }
        if(src2) {
            const b64 = await getBase64FromUrl(src2);
            if(b64) slide.addImage({ data: b64, x: 8.5, y: 4.3, w: 3, h: 2, sizing: { type: 'contain', w: 3, h: 2 } });
        }

        // 6. CAPTIONS
        slide.addText(document.getElementById('p_aswas_cap').innerText, { x: 0.5, y: 6.4, w: 6, align: 'center', fontSize: 10, color: '2E75B6', bold: true });
        slide.addText(document.getElementById('p_asis_cap').innerText, { x: 7.0, y: 6.4, w: 6, align: 'center', fontSize: 10, color: '2E75B6', bold: true });

        // 7. FOOTER
        slide.addText("Benefits", { x: 0.5, y: 6.9, w: 1.2, h: 0.5, fill: '2E75B6', color: 'FFFFFF', bold: true, align: 'center' });
        slide.addText("- " + document.getElementById('p_benefits').innerText, { x: 1.7, y: 6.9, w: 5, h: 0.5, border: {pt:1, color:'cccccc'}, fontSize: 11, valign:'middle' });
        slide.addTable([['Implementation Status', 'Remarks', 'ETA']], { x: 7.5, y: 6.9, w: 5.5, colW: [2, 2, 1.5], fontSize: 10, align: 'center', fill: 'ED7D31', color: 'FFFFFF', bold: true, border: {pt:1, color:'ffffff'} });
        slide.addTable([[document.getElementById('p_status').innerText, document.getElementById('p_remarks').innerText, document.getElementById('p_eta').innerText]], { x: 7.5, y: 7.2, w: 5.5, colW: [2, 2, 1.5], fontSize: 10, align: 'center', fill: 'FBE5D6', color: '000000', border: {pt:1, color:'ffffff'} });

        pres.writeFile({ fileName: `Kaizen_${document.getElementById('topic').value}.pptx` });
    } catch(e) {
        console.error(e);
        alert("Error generating PPT. Check images.");
    }
    
    btn.disabled = false; loader.style.display = "none";
}

// --- MONTHLY REPORT WITH FIXED IMAGES ---
async function downloadMonthlyPPT() {
    if(allRecords.length === 0) { alert("No data loaded. Please refresh data first."); return; }

    const selMonth = parseInt(document.getElementById('reportMonth').value);
    const selYear = parseInt(document.getElementById('reportYear').value);
    
    const filtered = allRecords.filter(r => {
        const d = new Date(r.date);
        return d.getMonth() === selMonth && d.getFullYear() === selYear;
    });

    if(filtered.length === 0) { alert("No records found for the selected month/year."); return; }

    const btn = document.getElementById('btnMonthlyPPT');
    const loader = document.getElementById('reportLoader');
    btn.disabled = true;
    loader.style.display = 'inline-block';

    try {
        let pres = new PptxGenJS();
        pres.layout = 'LAYOUT_WIDE'; 

        for(let r of filtered) {
            let slide = pres.addSlide();
            // ... (Same logic as single slide, but using 'r' object)
            slide.addText("Best Practices", { x: 0.5, y: 0.3, fontSize: 32, bold: true, color: '1F4E79', fontFace: 'Georgia' });
            slide.addImage({ path: "https://i.postimg.cc/5y7SN4xc/logo.png", x: 11.5, y: 0.2, w: 1.5, h: 0.6 });

            slide.addTable([['Plant', 'Area', 'Effect', 'Proposer']], { x: 8, y: 0.9, w: 5, colW: [1.2, 1.2, 1.4, 1.2], fontSize: 11, align: 'center', fill: 'f2f2f2', bold: true, color: '000000', border: {pt:1, color:'bfbfbf'} });
            slide.addTable([[ r.plant || "", r.area || "", r.effect || "", r.proposer || "" ]], { x: 8, y: 1.25, w: 5, colW: [1.2, 1.2, 1.4, 1.2], fontSize: 11, align: 'center', color: '000000', border: {pt:1, color:'bfbfbf'} });

            slide.addShape(pres.ShapeType.rect, { x: 0.5, y: 1.7, w: 0.15, h: 0.15, line: '555555', fill: 'ffffff' });
            slide.addText([ { text: "Topic- ", options: { color: 'C00000', bold: true } }, { text: r.topic || "", options: { color: '0070C0' } } ], { x: 0.7, y: 1.6, w: 12, fontSize: 18, bold: true });

            slide.addText("As-Was", { x: 0.5, y: 2.2, w: 1.5, h: 0.4, fill: '367FA9', color: 'FFFFFF', bold: true, align: 'center' });
            slide.addText("As-Is", { x: 7.0, y: 2.2, w: 1.5, h: 0.4, fill: '367FA9', color: 'FFFFFF', bold: true, align: 'center' });

            slide.addText(r.asWasPoints || "", { x: 0.5, y: 2.7, w: 6, h: 1.5, fontSize: 12, valign: 'top', bullet: true });
            slide.addText(r.asIsPoints || "", { x: 7.0, y: 2.7, w: 6, h: 1.5, fontSize: 12, valign: 'top', bullet: true });

            slide.addShape(pres.ShapeType.rect, { x: 0.5, y: 4.2, w: 6, h: 2.5, line: {type:'dash', color:'cccccc'}, fill:'fdfdfd' });
            slide.addShape(pres.ShapeType.rect, { x: 7.0, y: 4.2, w: 6, h: 2.5, line: {type:'dash', color:'cccccc'}, fill:'fdfdfd' });

            if(r.asWasImg) { const b64 = await getBase64FromUrl(r.asWasImg); if(b64) slide.addImage({ data: b64, x: 2.0, y: 4.3, w: 3, h: 2, sizing: { type: 'contain', w: 3, h: 2 } }); }
            if(r.asIsImg) { const b64 = await getBase64FromUrl(r.asIsImg); if(b64) slide.addImage({ data: b64, x: 8.5, y: 4.3, w: 3, h: 2, sizing: { type: 'contain', w: 3, h: 2 } }); }

            slide.addText(r.asWasCaption || "", { x: 0.5, y: 6.4, w: 6, align: 'center', fontSize: 10, color: '2E75B6', bold: true });
            slide.addText(r.asIsCaption || "", { x: 7.0, y: 6.4, w: 6, align: 'center', fontSize: 10, color: '2E75B6', bold: true });

            let etaStr = r.eta ? new Date(r.eta).toLocaleDateString() : "";
            slide.addText("Benefits", { x: 0.5, y: 6.9, w: 1.2, h: 0.5, fill: '2E75B6', color: 'FFFFFF', bold: true, align: 'center' });
            slide.addText("- " + (r.benefits || ""), { x: 1.7, y: 6.9, w: 5, h: 0.5, border: {pt:1, color:'cccccc'}, fontSize: 11, valign:'middle' });
            
            slide.addTable([['Implementation Status', 'Remarks', 'ETA']], { x: 7.5, y: 6.9, w: 5.5, colW: [2, 2, 1.5], fontSize: 10, align: 'center', fill: 'ED7D31', color: 'FFFFFF', bold: true, border: {pt:1, color:'ffffff'} });
            slide.addTable([[r.status || "", r.statusRemarks || r.remarks || "", etaStr]], { x: 7.5, y: 7.2, w: 5.5, colW: [2, 2, 1.5], fontSize: 10, align: 'center', fill: 'FBE5D6', color: '000000', border: {pt:1, color:'ffffff'} });
        }

        const monthName = document.getElementById('reportMonth').options[selMonth].text;
        pres.writeFile({ fileName: `Monthly_Kaizen_Report_${monthName}_${selYear}.pptx` });
    } catch(e) {
        console.error(e);
        alert("Error generating monthly report.");
    }

    loader.style.display = 'none';
    btn.disabled = false;
}

loadData();
</script>
</body>
</html>
